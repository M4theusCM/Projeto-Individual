<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../styles/gearup.css">
    <title>GearUP - Filmes</title>
    <link rel="icon" href="../src/logo.png">
    <link rel="stylesheet" href="../styles/feed.css">
    <script src="../js/sessao.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Chewy&family=Figtree:ital,wght@0,300..900;1,300..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Chewy&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Anton&family=Bebas+Neue&family=Chewy&family=Figtree:ital,wght@0,300..900;1,300..900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
    </style>
</head>

<body onload="validarSessao(), feed()">
    <div class="container-principal">
        <div class="menu-lateral">
            <div class="logo">
                <a href="./home.html">
                    <img src="../src/efeitos/gearup - efeito-claro.png" alt="GEARUP">
                </a>
            </div>
            <div class="area-links">
                <div class="links">
                    <a href="./home.html">
                        <img src="../src/icones/home-icon.png" class="menu-icons" alt="Home">
                        Pagina inicial
                    </a>
                </div>
                <div class="links">
                    <a href="./eventos.html">
                        <img src="../src/icones/evento-icon.png" class="menu-icons" alt="Calendario">
                        Eventos
                    </a>
                </div>
                <div class="links">
                    <a href="./jogos.html">
                        <img src="../src/icones/jogo-icon.png" class="menu-icons" alt="controle">
                        Jogos
                    </a>
                </div>
                <div class="links">
                    <a href="./filmes.html" class="selecionado">
                        <img src="../src/icones/filme-icon.png" class="menu-icons" alt="Claclete">
                        Filmes
                    </a>
                </div>
                <div class="links">
                    <a href="./carros.html">
                        <img src="../src/icones/carro-icon.png" class="menu-icons" alt="Carros">
                        Carros
                    </a>
                </div>
            </div>
            <div class="area-sair">
                <div class="links">
                    <a href="./perfil.html">
                        <img src="" alt="Perfil" id="perfil_img_menu" class="menu-img">
                        Perfil
                    </a>
                </div>
                <div class="links">
                    <button onclick="limparSessao()">
                        <img src="../src/icones/sair-icon.png" alt="Sair" class="menu-img">
                        Sair
                    </button>
                </div>
            </div>
        </div>
        <div class="container container-feed" id="container_feed">

        </div>
    </div>
</body>

</html>

<script>
    function feed() {
        var tipo = 'Filme'
        fetch(`/poster/buscarFeed/${tipo}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    // console.log(JSON.stringify(resposta))
                    exibir(resposta)
                });
            } else {
                console.log('Nenhum Feed encontrado ou erro na api')
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ feed: ${error.message}`)
            })
    }

    async function exibir(resposta) {
        // console.log(JSON.stringify(resposta))
        var posters = ''
        var qdtFeeds = resposta.length
        for (var i = 0; i < qdtFeeds; i++) {
            var feedAtual = resposta[i]
            var idPoster = feedAtual.idPoster
            var fkCriador = feedAtual.criadorPostagem
            var imgCurtida = await statusCurtida(idPoster, fkCriador,'inicializacao');
            var qtdCurtida = await buscarQtdCurtida(idPoster, fkCriador)
            var qtdComentario = await buscarQtdComentarios(idPoster, fkCriador)
            var comentarios = await comentariosDisplay(idPoster, fkCriador)
            // console.log('\t passou')
            posters += `
                <div class="card card-post" id="card_poster_id_${idPoster}">
                <div class="imgPost">
                    <img src="../src/posters/${feedAtual.imgPoster}" alt="Poster">
                </div>
                <div class="infosPost">
                    <div class="criador">
                        <img src="../src/perfils/${feedAtual.imgCriador}" alt="GR">
                        <p>${feedAtual.nickNameCriador}</p>
                    </div>
                    <div class="legendas">
                        <p>${feedAtual.legendaPoster}</p>
                    </div>
                    <div class="estatisticas">
                        <div  onclick="alterarStatusCurtida(${idPoster}, ${feedAtual.criadorPostagem})">
                            ${imgCurtida}
                            <p id="qtdCurtidas_poster_id_${idPoster}">${qtdCurtida}</p>
                            <span>Curtidas</span>
                        </div>
                        <div>
                            <img src="../src/icones/comentarios.png" alt="">
                            <p id="qtdComentario_poster_id_${idPoster}">${qtdComentario}</p>
                            <span>Comentarios</span>
                        </div>
                    </div>
                    <div class="comentarios-area" id="comentarios_area_display_${idPoster}">
                         ${comentarios}
                        <p>Ver mais</p>
                    </div>
                    <div class="add-comentario" onclick="addComentario(${idPoster})">
                        Comentar
                    </div>
                    <div class="modal_add" id="modal_id_${idPoster}">
                        <div class="fechar-add-poster" onclick="fecharModal(${idPoster})">
                            <img src="../src/acessos/Arrow 1.png" alt="Voltar">   
                        </div>
                        <label for="">
                            <h3>Digite o seu comentario:</h3>
                            <textarea class="ipt-comentario" id="txt_comentario_${idPoster}"></textarea>
                        </label>
                        <div  class="enviar">
                            <div onclick="enviar(${idPoster}, ${fkCriador})" class="button">
                                <p>Enviar</p>
                                <img src="../src/icones/Simplification.png" alt="->">
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            `
            container_feed.innerHTML = posters
        }
    }

    async function atualizarPoster(idPoster, fkCriador, tipo) {
        var divPoster = document.getElementById(`card_poster_id_${idPoster}`)
        if (tipo == 'Curtida') {
            var curtidaTemp = await buscarQtdCurtida(idPoster, fkCriador);
            var idCurtidaPoster = document.getElementById(`qtdCurtidas_poster_id_${idPoster}`)
            statusCurtida(idPoster, fkCriador,'atualizar')
            idCurtidaPoster.innerHTML = curtidaTemp
        } else {
            var comentarioTemp = await buscarQtdComentarios(idPoster, fkCriador)
            var novosComentarios = await comentariosDisplay(idPoster, fkCriador)
            var idComentarioPoster = document.getElementById(`qtdComentario_poster_id_${idPoster}`)
            var divExibirComentarios = document.getElementById(`comentarios_area_display_${idPoster}`)
            idComentarioPoster.innerHTML = comentarioTemp
            divExibirComentarios.innerHTML = novosComentarios

        }
    }


    // Comentarios
    function buscarQtdComentarios(idPoster, fkCriador) {
        return fetch("/comentarios/qtdComentario", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkPosterServer: idPoster,
                fkCriadorServer: fkCriador
            }),
        })

            .then(
                function (resposta) {
                    if (resposta.ok) {
                        return resposta.json().then(qtdComentarios => {
                            // console.log("To aq: "+JSON.stringify(qtdComentarios))
                            return qtdComentarios[0].qtdComentariosPoster
                        })
                    } else {
                        throw "Houve um erro ao tentar buscar a qtd de curtidas do poste!";
                    }
                })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });
    }

    function addComentario(idPoster) {
        var ipt = document.getElementById(`modal_id_${idPoster}`)
        ipt.style.display = `flex`
    }

    function fecharModal(idPoster) {
        var ipt = document.getElementById(`modal_id_${idPoster}`)
        ipt.style.display = `none`
    }

    function enviar(idPoster, fkCriador) {
        var fkUsuario = sessionStorage.ID_USUARIO
        var txt_comentario = document.getElementById(`txt_comentario_${idPoster}`)
        var comentario = (txt_comentario.value).trim()
        if (comentario != '') {
            fetch("/comentarios/comentar", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    fkPosterServer: idPoster,
                    fkCriadorServer: fkCriador,
                    fkUsuarioServer: fkUsuario,
                    comentarioServer: comentario
                }),
            })
                .then(function (resposta) {
                    if (resposta.ok) {
                        fecharModal(idPoster)
                        atualizarPoster(idPoster, fkCriador, 'Comentario')
                    } else {
                        throw "Houve um erro ao tentar realizar o cadastro!";
                    }
                })
                .catch(function (resposta) {
                    console.log(`#ERRO: ${resposta}`);
                    finalizarAguardar();
                });
        }
    }

    function comentariosDisplay(idPoster, fkCriador) {
        return fetch("/comentarios/comentariosDisplay", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkPosterServer: idPoster,
                fkCriadorServer: fkCriador
            }),
        })

            .then(
                function (resposta) {
                    if (resposta.ok) {
                        return resposta.json().then(comentariosPoster => {
                            // console.log("To aq: " + JSON.stringify(comentariosPoster))
                            var tamanhoComentariosPoster = comentariosPoster.length
                            var comentarioCaixinha = ''
                            /*
                                <div class="comentarios"></div>
                            */
                            var msg = ''
                            // console.log(comentariosPoster[0])
                            for (var i = 0; i < tamanhoComentariosPoster; i++) {
                                var comentarioAtual = comentariosPoster[i]
                                msg += `
                                    <div class="comentarios">
                                        <div class="criadorComentario">
                                            <img src="../src/perfils/${comentarioAtual.Imgusuario}" alt="">
                                            <p>${comentarioAtual.nomeUsuario} </p>
                                            </div>                
                                            <p class="testo_comentado">${comentarioAtual.comentario}</p>
                                    </div>
                                `
                            }
                            return msg
                        })
                    } else {
                        throw "Houve um erro ao tentar buscar a qtd de curtidas do poste!";
                    }
                })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });
    }



    // Curtidas
    function buscarQtdCurtida(idPoster, fkCriador) {
        return fetch("/curtidas/qtdCurtida", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkPosterServer: idPoster,
                fkCriadorServer: fkCriador
            }),
        })

            .then(
                function (resposta) {
                    if (resposta.ok) {
                        return resposta.json().then(qtd => {
                            // console.log("To aq: " + JSON.stringify(qtd))
                            return qtd[0].qtdCurtidasPoster
                        })
                    } else {
                        throw "Houve um erro ao tentar buscar a qtd de curtidas do poste!";
                    }
                })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });
    }

    function statusCurtida(idPoster, fkCriador, tipo) {
        var fkUsuario = sessionStorage.ID_USUARIO
        return fetch("/curtidas/buscarStatus", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkPosterServer: idPoster,
                fkUsuarioServer: fkUsuario,
                fkCriadorServer: fkCriador
            }),
        })
            .then(
                function (resposta) {
                    // console.log("resposta: ", resposta);
                    if (resposta.ok) {
                        //  var a = 'bom bom bom'
                        // return a
                        return resposta.json().then(status => {
                            // console.log("Olha o status: "+JSON.stringify(status))
                            var statusPost = status[0].statusCurtida
                            console.log("Olha Aq:"+statusPost)
                            if (tipo == 'inicializacao') {
                                if (statusPost == 0) {
                                    // console.log(statusPost)
                                    var imgTemp = `<img class="curtidaBotao" src="../src/icones/Coracao0.png" id="img_status_curtida_poster_${idPoster}" alt="Curtir">`
                                } else {
                                    var imgTemp = `<img class="curtidaBotao" src="../src/icones/coracao1.png" id="img_status_curtida_poster_${idPoster}" alt="Descurtir">`
                                }
                                return imgTemp

                            } else {
                                var imgStatusCurtidaPoster = document.getElementById(`img_status_curtida_poster_${idPoster}`)
                                // console.log(imgStatusCurtidaPoster)
                                if (statusPost == 0) {
                                    // console.log(statusPost)
                                    imgStatusCurtidaPoster.src = '../src/icones/Coracao0.png'
                                } else {
                                    imgStatusCurtidaPoster.src = '../src/icones/Coracao1.png'
                                }
                            }
                        })
                    } else {
                        throw "Houve um erro ao tentar curtir!";
                    }
                })
            .catch(function (resposta) {
                // console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });
    }

    function alterarStatusCurtida(idPoster, fkCriador) {
        var fkUsuario = sessionStorage.ID_USUARIO

        // console.log('a')

        fetch("/curtidas/alterarStatus", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                fkPosterServer: idPoster,
                fkUsuarioServer: fkUsuario,
                fkCriadorServer: fkCriador
            }),
        })

            .then(
                function (resposta) {
                    if (resposta.ok) {
                        resposta.json().then(status => {
                            // console.log(JSON.stringify(status))
                            atualizarPoster(idPoster, fkCriador, 'Curtida')
                        })
                    } else {
                        throw "Houve um erro ao tentar realizar curtida!";
                    }
                })
            .catch(function (resposta) {
                // console.log(`#ERRO: ${resposta}`);
                finalizarAguardar();
            });
    }

</script>